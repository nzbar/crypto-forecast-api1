# ----------------------------------------------------
# Dockerfile لتطبيق Flask مع خادم Gunicorn
# مصمم ليعمل مع خدمة ويب ومهمة تدريب مجدولة
# ----------------------------------------------------

# الخطوة 1: ابدأ من صورة بايثون رسمية وخفيفة
FROM python:3.9-slim

# الخطوة 2: تجهيز بيئة العمل
# يمنع بايثون من إنشاء ملفات .pyc ويضمن طباعة المخرجات مباشرة
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# تحديد مجلد العمل داخل الحاوية
WORKDIR /app

# الخطوة 3: تثبيت المكتبات
# نستخدم النسخة الموحدة التي تخدم التدريب والتشغيل معاً
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# الخطوة 4: انسخ كود المشروع بالكامل
# هذا ينسخ app.py, train_worker.py, وكل المجلدات مثل pretrain
COPY . .

# الخطوة 5: تشغيل الخادم (الأمر الافتراضي لخدمة الويب)
# منصة Render ستتجاهل هذا الأمر عند تشغيل المهمة المجدولة
# وستستخدم الأمر المحدد في render.yaml بدلاً منه
EXPOSE 8000
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "--timeout", "600", "app:app"]

